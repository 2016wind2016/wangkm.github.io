<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>wangkm&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="梦醒了，踏上心的旅程">
<meta property="og:type" content="website">
<meta property="og:title" content="wangkm&#39;s blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="wangkm&#39;s blog">
<meta property="og:description" content="梦醒了，踏上心的旅程">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="wangkm&#39;s blog">
<meta name="twitter:description" content="梦醒了，踏上心的旅程">
  
    <link rel="alternate" href="/atom.xml" title="wangkm&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">wangkm&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-广播服压测总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/09/10/广播服压测总结/" class="article-date">
  <time datetime="2018-09-10T02:24:50.000Z" itemprop="datePublished">2018-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/10/广播服压测总结/">广播服压测总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>游戏即将上线，本周对广播服进行压力测试，不断调整代码，最终达成了单进程2000人的目标。一些注意事项和大家分享下。</p>
<h2 id="服务端策略"><a href="#服务端策略" class="headerlink" title="服务端策略"></a>服务端策略</h2><h3 id="采用集群方式，单进程连接数量控制在2000人"><a href="#采用集群方式，单进程连接数量控制在2000人" class="headerlink" title="采用集群方式，单进程连接数量控制在2000人"></a>采用集群方式，单进程连接数量控制在2000人</h3><ol>
<li><p>获取连接数量</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wss.clients.size;</span><br></pre></td></tr></table></figure>
</li>
<li><p>当连接数达到2000人时，服务端断开客户端并返回错误码。</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsClient.close(<span class="number">1008</span>, <span class="string">'connector num max'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接但5秒内不完成登录验证的客户端要关闭</p>
</li>
</ol>
<h3 id="同一个频道玩家集中在同一个进程"><a href="#同一个频道玩家集中在同一个进程" class="headerlink" title="同一个频道玩家集中在同一个进程"></a>同一个频道玩家集中在同一个进程</h3><ol>
<li>连接端口作为数组返回给客户端</li>
<li>客户端从第一个端口轮询请求可以连接的服务端，直到连接成功。</li>
</ol>
<p>减少RPC操作，提升通信效率，虽然策略有点低级。</p>
<h3 id="广播相关"><a href="#广播相关" class="headerlink" title="广播相关"></a>广播相关</h3><ol>
<li>消息广播区域分级，频道内、进程内，当前服，所有服</li>
<li>不同广播区域需要不同的权限，所有服不对客户端开放。</li>
<li>不同广播区域的消息冷却时间不同。</li>
</ol>
<h3 id="消息相关"><a href="#消息相关" class="headerlink" title="消息相关"></a>消息相关</h3><ol>
<li>精简消息内容，删除消息内无用数据，尤其优化通讯频繁的消息。</li>
<li>心跳时间频率适当降低，调整为10秒一次。</li>
<li>心跳信息不打印。</li>
</ol>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><ol>
<li>打印接收的消息</li>
<li>打印一些重要日志</li>
<li>不打印发送给客户端的消息</li>
</ol>
<p>适当降低日志，能提升服务端承载能力。</p>
<h2 id="机器人策略"><a href="#机器人策略" class="headerlink" title="机器人策略"></a>机器人策略</h2><ol>
<li>每0.5s创建一个机器人进程</li>
<li>登录聊天服务器</li>
<li>10s一次心跳</li>
<li>30s一次玩家状态同步</li>
<li>35s一次世界聊天(频道内200人广播)</li>
<li>90s一次随机推荐好友(进程内随机)</li>
<li>120s一次房间招人(当前进程内所有人广播)</li>
<li>聊天关闭则从步骤2重新开始</li>
</ol>
<h2 id="测试策略"><a href="#测试策略" class="headerlink" title="测试策略"></a>测试策略</h2><ol>
<li>采用和线上同样的环境测试。</li>
<li>短期测试可按小时、天来申请服务器测试。</li>
<li>受网络限制，测试机器人和服务器之间内网通信。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/09/10/广播服压测总结/" data-id="cjlvo0oq200064svnqt5svf97" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-游戏任务系统的设计(下)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/13/游戏任务系统的设计(下)/" class="article-date">
  <time datetime="2018-08-13T02:15:37.000Z" itemprop="datePublished">2018-08-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/13/游戏任务系统的设计(下)/">游戏任务系统的设计(下)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>刚水好的一篇博客被VSCode吞了，也是够够的，好吧我重来。<br>本打算分享一下这周内做的GRpc的简单封装呢，手里没代码，那就先把任务系统了结吧。</p>
<h2 id="任务对象"><a href="#任务对象" class="headerlink" title="任务对象"></a>任务对象</h2><p>因为涉及到任务奖励的分发，需要记录奖励的领取状态，落后的社会生产力不能满足人民日益增长的物质文化需求，于是大笔一挥增加了任务奖励的领取状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"type"</span> : <span class="number">0</span> <span class="comment">//日常、周常、成就</span></span><br><span class="line">  <span class="string">"mode"</span> : <span class="number">0</span> <span class="comment">//任务具体枚举类型</span></span><br><span class="line">  <span class="string">"cfgId"</span> : <span class="number">0</span> <span class="comment">//对应静态配置ID，用于查询具体</span></span><br><span class="line">  <span class="string">"num"</span> : <span class="number">0</span> <span class="comment">//任务需求数量、名次、等级</span></span><br><span class="line">  <span class="string">"rewardState"</span> : <span class="number">0</span> <span class="comment">//0:未领取，1:已领取</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>状态切换</li>
</ul>
<ol>
<li>任务未完成：任务对象num达到奖励未要求的阈值</li>
<li>任务已完成：任务对象num达到奖励要求的阈值</li>
<li>奖励未领取：任务已完成，且rewardState为0</li>
<li>奖励已领取：任务已完成，且rewardState为1</li>
</ol>
<h3 id="奖励发送"><a href="#奖励发送" class="headerlink" title="奖励发送"></a>奖励发送</h3><p>我们采取的是，玩家主动请求任务奖励的方式来领取对应的奖励。</p>
<ul>
<li>日常、周常</li>
</ul>
<ol>
<li>奖励未领取状态</li>
<li>rewardState置为已领取状态</li>
<li>删除任务对象</li>
<li>触发ALL型任务</li>
<li>发送任务奖励</li>
</ol>
<ul>
<li>成就</li>
</ul>
<p>成就设计到统计成就点、展示成就完成时间、人前显圣晒的心理，成就领取完奖励就不予删除。</p>
<ol>
<li>奖励未领取状态</li>
<li>rewardState置为已领取状态</li>
<li>触发ALL型任务</li>
<li>发送任务奖励</li>
</ol>
<h3 id="任务动态增加"><a href="#任务动态增加" class="headerlink" title="任务动态增加"></a>任务动态增加</h3><p>任务不可能一成不变，实现动态增加是一个硬性的需求。</p>
<ul>
<li>日常、周常</li>
</ul>
<p>日常、周常有刷新时间，只要达到刷新时间清除所有已创建任务对象，重新载入所有任务对象即可。</p>
<ul>
<li>成就</li>
</ul>
<p>成就因为没有刷新时间，所以需要一定的策略。</p>
<ol>
<li>成就ID必须增量增加。</li>
<li>成就有删减ID不回收。</li>
<li>线上阶段，ID有删除操作一般禁止，或者做额外策略。</li>
<li>线上阶段，ID对应任务类型变更禁止。</li>
<li>任意阶段修改ID对应Num值，允许。</li>
<li>角色创建，角色身上绑定最大成就ID</li>
<li>玩家登录，对比自身最大成就ID和当前最大成就ID</li>
<li>成就有更新，增加(自身最大成就ID, 当前最大成就ID]内所有成就。</li>
</ol>
<p>当前成就的策略向应用到日常、周常上也可以。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>2个篇幅任务系统总算完结了，也算是一个比较长的一篇博客了，当然项目中的任务系统肯定要比此复杂，但基本样子应该差距不算太大。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/13/游戏任务系统的设计(下)/" data-id="cjlvo0oq6000a4svnsck5c524" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-基于RPC的分布式广播服设计思路" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/06/基于RPC的分布式广播服设计思路/" class="article-date">
  <time datetime="2018-08-06T02:21:00.000Z" itemprop="datePublished">2018-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/06/基于RPC的分布式广播服设计思路/">基于RPC的分布式广播服设计思路</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>先前设计了一种基于Redis的分布式广播服，实际项目运行一段时间后，有几个问题需要面对</p>
<ol>
<li>整体依赖Redis整个广播服的压力受限于Redis的吞吐量。</li>
<li>因为项目主短连接的， 广播服需要承担一些长连接的逻辑，依赖Redis数据更新并不方便。</li>
<li>因为未进行聊天室拆分，人数N多时广播风暴不可避免</li>
<li>广播时基于Redis的发布订阅，玩家数据未标识玩家进程UID,进程多时数据交互效率不高</li>
</ol>
<p>本文主要讲针对上面几个问题重新设计的一个基于RPC的分布式广播服(纯理论，实际项目刚着手)。</p>
<h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>需要几种类型服务器</p>
<ol>
<li>connecter 集群，保持和客户端的长连接，用于信息广播和一些交互的逻辑</li>
<li>chatRoomMgr 单点，聊天室拆分、合理的分散玩家到各个聊天室</li>
<li>master  单点，管理各个服务器进程的状态，记录和广播各个注册服务器的状态</li>
<li>gameserver 集群，http服务器，和客户端连接（已存在，显示说明为了解释方便）</li>
</ol>
<h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>RPC基于webSocket，端口采用独立端口不和Clint连接的端口复用，用于服务端接口调用及维护服务器状态。</p>
<h3 id="master"><a href="#master" class="headerlink" title="master"></a>master</h3><ol>
<li>master服务器启动</li>
<li>非master进程启动时RPC向master注册自己服务器信息，以及取得其它注册服务器的信息。</li>
<li>非master进程，RPC连接其它注册服务器。</li>
<li>每个连接master的服务器，每30秒左右定时汇报自己服务器基本信息(可以夹带私货比如服务器人数，房间人数))。</li>
<li>非master进程状态变更，master服务器向所有注册到自己服务器广播启动、关闭等消息。</li>
<li>master提供接口用于RPC向此采集数据。</li>
</ol>
<h3 id="gameserver"><a href="#gameserver" class="headerlink" title="gameserver"></a>gameserver</h3><ol>
<li>启动，RPC连接各个进程</li>
<li>客户端http连接gameserver</li>
<li>gameserver通过RPC向connecter写入玩家的基本信息</li>
<li>gameserver返回一个connecter地址</li>
</ol>
<h3 id="connecter"><a href="#connecter" class="headerlink" title="connecter"></a>connecter</h3><ol>
<li>启动，RPC连接各个进程</li>
<li>客户端webSocket连接connecter</li>
<li>通用连接验证，connecter通过RPC向chatRoomMgr申请一个聊天室ID，并写入连接信息</li>
<li>connecter返回客户端聊天室ID</li>
<li>向master同步数据提供连接人数</li>
</ol>
<h3 id="chatRoomMgr"><a href="#chatRoomMgr" class="headerlink" title="chatRoomMgr"></a>chatRoomMgr</h3><ol>
<li>启动，RPC连接各个进程</li>
<li>启动聊天室功能，等待RPC请求创建聊天室，聊天室从1开始，每200人新增一个频道</li>
<li>聊天内容不入库，客户端可以缓存</li>
</ol>
<h2 id="基本流程"><a href="#基本流程" class="headerlink" title="基本流程"></a>基本流程</h2><ul>
<li>聊天</li>
</ul>
<ol>
<li>客户端向聊天室发送消息</li>
<li>connecter接收消息</li>
<li>connecter向chatRoomMgr请求聊天消息</li>
<li>chatRoomMgr通过RPC向聊天室内各个玩家所在connector广播聊天消息</li>
</ol>
<ul>
<li>密集聊天（比较幼稚的思路）</li>
</ul>
<ol>
<li>每个聊天广播做个50条大小的数组，所有聊天消息先入数组</li>
<li>上次广播未推送完毕，等待广播</li>
<li>上次广播所有已推送完毕1秒左右，一次全部取出未广播的消息进行推送</li>
</ol>
<ul>
<li>系统广播</li>
</ul>
<ol>
<li>类似聊天室，但得消息缓存做一个优先原则</li>
<li>消息池总条数不变，若消息池已满优先级高的消息会挤优先级低的空间，相同优先级先到先得</li>
<li>直接由gameServer向各个connector广播系统消息</li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>一个常规的高仿Pomelo的分布式系统，全靠自己撸的话，开发设计难度不低，造轮子。chatRoomMgr单点的设计感觉不是很保险，应该从结构上想办法调整为可以集群。项目结构整体调整完毕再重发一版本说明吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/06/基于RPC的分布式广播服设计思路/" data-id="cjlvo0opz00034svn5s0esxkp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-提问的智慧-读书笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/31/提问的智慧-读书笔记/" class="article-date">
  <time datetime="2018-07-31T02:24:24.000Z" itemprop="datePublished">2018-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/31/提问的智慧-读书笔记/">提问的智慧-读书笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为一名光荣的程序猿，我们使用不同的开发工具来创建自己的世界。本文主要讲解当我们使用工具出现问题时出现问题时，我们应该如何高效的提问问题。</p>
<h2 id="在提问之前"><a href="#在提问之前" class="headerlink" title="在提问之前"></a>在提问之前</h2><blockquote>
<ol>
<li>尝试在你准备提问的论坛的旧文章中搜索答案。</li>
<li>尝试上网搜索以找到答案。</li>
<li>尝试阅读手册以找到答案。</li>
<li>尝试阅读常见问题文件（FAQ）以找到答案。</li>
<li>尝试自己检查或试验以找到答案</li>
<li>向你身边的强者朋友打听以找到答案。</li>
<li>如果你是程序开发者，请尝试阅读源代码以找到答案。</li>
</ol>
</blockquote>
<p>提出问题前，我们应该利用自身能想到的方式去获得答案，毕竟每个人的时间都不是免费的，尊重别人即尊重自己。</p>
<h2 id="提问问题时"><a href="#提问问题时" class="headerlink" title="提问问题时"></a>提问问题时</h2><ol>
<li>确认需要反馈问题需要时，我们应该官方的论坛以及针对的模块。不要重复发帖以及技术论坛灌水以及做其它感觉很酷的事情，这样只会彰显自己不专业。</li>
<li>当某个项目提供开发者邮件列表时，应该使用项目邮件列表。</li>
<li>使用有意义且描述明确的标题，简洁且突出重点。</li>
<li>内容采用清晰、正确、精准并语法正确的语句，要明确问题点，以及发生条件。</li>
<li>使用易于读取且标准的文件格式，简化交流的难度。</li>
<li>态度要真诚。</li>
<li>问题解决后，加个简短的补充说明。首先对帮助的人表示感谢，然后给予关注或以后遭遇此问题的人提供帮助。</li>
</ol>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>发现问题后，高效解决问题的能力是成为技术大牛的必经之路。发现问题，提问的智慧，不仅是问的智慧，更多的是一个正确的提问和解决问题的流程。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/31/提问的智慧-读书笔记/" data-id="cjlvo0oq400084svny3k6eem1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-玩家定时器模块的设计与实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/26/玩家定时器模块的设计与实现/" class="article-date">
  <time datetime="2018-07-26T04:51:35.000Z" itemprop="datePublished">2018-07-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/26/玩家定时器模块的设计与实现/">玩家定时器模块的设计与实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>游戏开发中，玩家一些定时刷新的物品、任务，若每个对象都增加一个setTimeout函数，数量就很恐怖了，尤其是玩家数量一多就更废了。本文针对这一现象，设计了一种线性定时器，它同时只有一个定时事件处于激活状态，当前定时事件处理完毕会启动下一个定时事件。</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>玩家角色可以穿多件时装，时装又有时间限制，时装时间到期后，需要服务端把到期的时装卸下。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p>为每个装扮增加一个定时器，到期时卸下装扮。<br>这就需要面对玩家有N个装扮，就需要同时启动N个定时器的问题。</p>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p>不做定时器，每次每次客户端请求一下，所有时装遍历一遍进行到期卸载的逻辑处理。<br>由于无脑遍历，付出的计算量和实现的功能相比，有点得不偿失，尤其是涉及到更多的定时时。</p>
<h3 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h3><p>做一个数组，数组内每个成员记录装扮ID和过期时间，并对时间从小到大排序。<br>装扮模块增加一个定时器，时间是数组第一个元素时间，时间到期卸载对应装扮，并pop指定此成员。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        SkinId:<span class="number">30001</span>,</span><br><span class="line">        endTime:<span class="number">1000000</span>,</span><br><span class="line">    &#125;，</span><br><span class="line">    &#123;</span><br><span class="line">        SkinId:<span class="number">30002</span>,</span><br><span class="line">        endTime:<span class="number">2000000</span>,</span><br><span class="line">    &#125;，</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>此方案单对装扮是比较完美，但仍不能避免玩家多种不同类型的定时事件，会同时启动多个定时器的问题。</p>
<h3 id="方案四"><a href="#方案四" class="headerlink" title="方案四"></a>方案四</h3><p>其实就是方案三的改良版，把设计一个定时器模块，此模块内部维护一个数组，数据内成员具有基本属性{type:事件类型，endTime:响应时间，id:目标ID…},数组内部依然对每个成员按响应事件按从下到大排序。</p>
<p>此方案实现了玩家身上，同时只有一个定时器模块响应的需求，同时又能高效的处理按时间监听的事件。</p>
<h2 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//监听类型</span></span><br><span class="line"><span class="keyword">const</span> LISTENER_TYPE = &#123;</span><br><span class="line">    APPEARANCE: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 生成监听</span></span><br><span class="line"><span class="comment"> * @param &#123;LISTENER_TYPE&#125; type</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; end_time</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; id //索引可以是对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NewListener</span>(<span class="params">type, end_time, id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        type: type,</span><br><span class="line">        end_time: end_time,</span><br><span class="line">        id: id,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 增加监听</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; userData 玩家</span></span><br><span class="line"><span class="comment"> * @param &#123;NewListener&#125; listener</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AddListener</span>(<span class="params">userData, listener</span>) </span>&#123;</span><br><span class="line">    MF.Log.logDebug(<span class="string">'AddListener: '</span>, <span class="built_in">JSON</span>.stringify(listener));</span><br><span class="line">    <span class="keyword">if</span>(!userData.Timer) &#123;</span><br><span class="line">        userData.Timer = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(listener.end_time &lt;= <span class="number">0</span> || listener.type === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        MF.Log.logError(<span class="string">'AddListener: '</span>, <span class="built_in">JSON</span>.stringify(listener));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    userData.Timer.push(listener);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = userData.Timer.length - <span class="number">1</span>; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span>(userData.Timer[i<span class="number">-1</span>].end_time &lt;= userData.Timer[i].end_time) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> tmp = userData.Timer[i];</span><br><span class="line">        userData.Timer[i] = userData.Timer[i<span class="number">-1</span>];</span><br><span class="line">        userData.Timer[i<span class="number">-1</span>] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 添加并踢出雷同的，更新序列</span></span><br><span class="line"><span class="comment"> * !!添加并向前排除相同的</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; userData 玩家</span></span><br><span class="line"><span class="comment"> * @param &#123;NewListener&#125; listener</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UpdateListener</span>(<span class="params">userData, listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!userData.Timer) &#123;</span><br><span class="line">        userData.Timer = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(listener.end_time &lt;= <span class="number">0</span> || listener.type === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        MF.Log.logError(<span class="string">'AddListener: '</span>, <span class="built_in">JSON</span>.stringify(listener));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    userData.Timer.push(listener);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = userData.Timer.length - <span class="number">1</span>; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span>(userData.Timer[i<span class="number">-1</span>].type === listener.type &amp;&amp;</span><br><span class="line">            userData.Timer[i<span class="number">-1</span>].end_time !== listener.end_time &amp;&amp;</span><br><span class="line">            <span class="built_in">JSON</span>.stringify(userData.Timer[i<span class="number">-1</span>].id) === <span class="built_in">JSON</span>.stringify(listener.id)) &#123;</span><br><span class="line">            userData.Timer.splice(i<span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line">            i--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(userData.Timer[i<span class="number">-1</span>].end_time &lt;= userData.Timer[i].end_time) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> tmp = userData.Timer[i];</span><br><span class="line">        userData.Timer[i] = userData.Timer[i<span class="number">-1</span>];</span><br><span class="line">        userData.Timer[i<span class="number">-1</span>] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 运行</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; userData 玩家</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AutoRun</span>(<span class="params">userData</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> curTime = MF.Util.CurTimeStamp();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; userData.Timer.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> listener = userData.Timer[i];</span><br><span class="line">        <span class="keyword">if</span>(curTime &lt; listener.end_time) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        EndTimerEvent(userData, listener);</span><br><span class="line">        userData.Timer.splice(i, <span class="number">1</span>);</span><br><span class="line">        i--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 触发监听事件</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; userData 玩家</span></span><br><span class="line"><span class="comment"> * @param &#123;NewListener&#125; listener</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">EndTimerEvent</span>(<span class="params">userData, listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> type = listener.type;</span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> LISTENER_TYPE.APPEARANCE: &#123;</span><br><span class="line">            WW.Appearance.OnEndTimerEvent(userData, listener);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            MF.Log.logError(<span class="string">'Listener type not defined: '</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">arguments</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上述是一个方案四的变种，AutoRun函数没有用定时器，因为项目中玩家数据是在Redis中存放的，所以在每次Redis取玩家数据后调用AutoRun函数。如果玩家数据在内存中可以自行改写AutoRun函数。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/26/玩家定时器模块的设计与实现/" data-id="cjlvo0oq9000c4svnwa1zldyh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-游戏任务系统的设计(上)" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/16/游戏任务系统的设计(上)/" class="article-date">
  <time datetime="2018-07-16T02:49:27.000Z" itemprop="datePublished">2018-07-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/16/游戏任务系统的设计(上)/">游戏任务系统的设计(上</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>忙忙碌碌地又一周过去了，又到了每周博客的时间了，这一周疲惫地推各种功能，没带脑子思考，又没心思用半天时间做一个新的功能探讨，终了翻了翻以前设计的功能，接下来就拿自己设计的任务系统做讲解了。</p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>任务系统需求有三种：</p>
<ul>
<li>每日任务：每个任务有独立的奖励，每日还有活跃度，活跃度可以兑换奖励，任务有次数限制，每日凌晨3点刷新，并清除活跃度。</li>
<li>周任务：周任务没有活跃度，除了个人奖励外，会增加公会积分，不可重复完成，每周一凌晨3点刷新。</li>
<li>成就：主要奖励成就点（用于显示玩家水平的一种方式），成就不可刷新。</li>
</ul>
<p>任务类型分类：</p>
<ul>
<li>聊天：世界频道发送**条信息 (日常)</li>
<li>战斗：扫荡**关卡次 (日常)</li>
<li>好友：添加**个好友 (日常)</li>
<li>战斗：进行世界Boss达到**名 (周常、成就)</li>
<li>登录：玩家累计登录**次数可完成 (日常、成就、周常)</li>
<li>卡牌：玩家培养**次卡牌 (日常)</li>
<li>卡牌：玩家拥有**张卡牌 (成就)</li>
<li>卡牌：玩家拥有**张X星卡牌 (成就)</li>
</ul>
<p>…我又不是策划就不一一枚举了</p>
<h2 id="功能提取"><a href="#功能提取" class="headerlink" title="功能提取"></a>功能提取</h2><ul>
<li>刷新处理</li>
<li>任务类型分类</li>
<li>任务分发</li>
<li>任务记录</li>
<li>任务触发</li>
<li>奖励发送</li>
<li>任务动态增加</li>
</ul>
<p>…仔细想想提取的又不是那个的有条理</p>
<h2 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h2><p>终于可以晒代码，水篇幅了，作为一个服务器端程序员，讲故事的确不是我所长。</p>
<h3 id="刷新"><a href="#刷新" class="headerlink" title="刷新"></a>刷新</h3><p>1、玩家每次登录时，上次刷新时间戳和当前时间做比较</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isEnableRefresh</span>(<span class="params">lastTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hour5Time = <span class="built_in">Math</span>.floor(<span class="keyword">new</span> <span class="built_in">Date</span>().setHours(<span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) / <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> ((lastTime &lt; hour5Time) &amp;&amp; ((lastTime &lt; hour5Time - <span class="number">86400</span>) || (utils.timestamp() &gt;= hour5Time)));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>2、系统每日3天发送刷新事件，每个在线玩家的任务刷新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sysDailyRefresh</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> nextTime = <span class="built_in">Math</span>.floor(<span class="keyword">new</span> <span class="built_in">Date</span>().setHours(<span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) / <span class="number">1000</span>) + <span class="number">86400</span>;</span><br><span class="line">  <span class="keyword">let</span> seconds = nextTime - utils.timestamp();</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    userDailyRefresh();</span><br><span class="line">    sysDailyRefresh();</span><br><span class="line">  &#125;, seconds * <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>3.周任务，需要判断判断再添加今日是否是周一即可</p>
<h3 id="任务类型分类"><a href="#任务类型分类" class="headerlink" title="任务类型分类"></a>任务类型分类</h3><p>仔细分各种任务类型，再一一枚举</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> TASK_MODE = &#123;</span><br><span class="line">    FINISH_TASK: &#123;</span><br><span class="line">      ALL:            <span class="number">11</span>,  <span class="comment">//所有</span></span><br><span class="line">    &#125;,</span><br><span class="line">    RANDOM_CARD: &#123;</span><br><span class="line">      NUM:            <span class="number">21</span>,  <span class="comment">//召唤-累计召唤</span></span><br><span class="line">    &#125;,</span><br><span class="line">    BATTLE: &#123;</span><br><span class="line">      MAIN:           <span class="number">31</span>,  <span class="comment">//战斗-主线剧情</span></span><br><span class="line">      UNLIMITED:      <span class="number">32</span>,  <span class="comment">//战斗-无限模式</span></span><br><span class="line">      WORLD_BOSS:     <span class="number">33</span>,  <span class="comment">//战斗-世界Boss</span></span><br><span class="line">    &#125;,</span><br><span class="line">    FRIEND: &#123;</span><br><span class="line">      HAVE:           <span class="number">41</span>,  <span class="comment">//好友-拥有好友</span></span><br><span class="line">    &#125;,</span><br><span class="line">    CARD: &#123;</span><br><span class="line">      LEVEL_DEV:      <span class="number">51</span>,  <span class="comment">//卡牌-培养</span></span><br><span class="line">      LEVEL:          <span class="number">52</span>,  <span class="comment">//卡牌-等级</span></span><br><span class="line">      STAR:           <span class="number">53</span>,  <span class="comment">//卡牌-星级拥有</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再具体细分抽象可以为三类</p>
<ul>
<li>累计型：需要玩家手动触发的，每次响应累计+1，比如累计登陆、聊天次数</li>
<li>拥有型：总共拥有多少，比如拥有卡牌数量</li>
<li>排名型：达到多少名，因为和累计判断相反，故单独抽出来</li>
<li>ALL型：完成所有任务，这种一般针对日常任务</li>
</ul>
<h3 id="任务分发"><a href="#任务分发" class="headerlink" title="任务分发"></a>任务分发</h3><p>简单的采用玩家上线自动领取，毕竟是个坑钱的手游，那么任务触发的设计情怀。</p>
<h3 id="任务记录"><a href="#任务记录" class="headerlink" title="任务记录"></a>任务记录</h3><p>因为都是一些简单的任务，可以抽象成下面几个属性记录即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"type"</span> : <span class="number">0</span> <span class="comment">//日常、周常、成就</span></span><br><span class="line">    <span class="string">"mode"</span> : <span class="number">0</span> <span class="comment">//任务具体枚举类型</span></span><br><span class="line">    <span class="string">"cfgId"</span> : <span class="number">0</span> <span class="comment">//对应静态配置ID，用于查询具体</span></span><br><span class="line">    <span class="string">"num"</span> : <span class="number">0</span> <span class="comment">//任务需求数量、名次、等级</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>刷新、完成领取奖励后，直接删除即可。<br>任务完成的状态只有玩家领取任务奖励成功才出发。</p>
<h3 id="任务触发"><a href="#任务触发" class="headerlink" title="任务触发"></a>任务触发</h3><p>分为条件触发和登录触发两种方式</p>
<h4 id="登录触发"><a href="#登录触发" class="headerlink" title="登录触发"></a>登录触发</h4><p>顾名思义，玩家登录后，需要遍历玩家数据，后直接触发任务，主要应对拥有型任务。<br>eg:每次玩家上线，都要计算玩家卡组数量，并触发任务发送任务类型、以及卡牌数量。</p>
<h4 id="条件触发"><a href="#条件触发" class="headerlink" title="条件触发"></a>条件触发</h4><p>直接举例说明，每次玩家获得卡牌都要计算玩家卡组数量，并触发任务发送任务类型、以及卡牌数量。</p>
<p>其实条件触发基本上所有任务类型都可以截获，但登录触发如果没有的话手动修改数据、新增成就任务等都无法兼容，所以登录触发是有必要的，尤其是针对一次性的成就。</p>
<p>下面是具体针四种抽象的任务类型的响应</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 常规通用任务触发</span></span><br><span class="line"><span class="comment"> * 累计型</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; objTask 任务Obj</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; num 数量</span></span><br><span class="line"><span class="comment"> * @return &#123;Boolean&#125; 是否移除任务监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commonTrigger</span> (<span class="params">objTask, num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isRemoveListener;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    isRemoveListener = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">let</span> tbObjTask = Config.getTbObjTask(objTask.getAttrInt(<span class="string">'type'</span>), objTask.getAttrInt(<span class="string">'cfgId'</span>));</span><br><span class="line">    <span class="keyword">if</span>(!tbObjTask) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> oldNum = objTask.getAttrInt(<span class="string">'num'</span>);</span><br><span class="line">    <span class="keyword">let</span> maxNum = tbObjTask[<span class="string">"num"</span>];</span><br><span class="line">    <span class="keyword">let</span> isMax = (oldNum + num) &gt;= maxNum;</span><br><span class="line">    <span class="keyword">let</span> newNum = isMax ? maxNum : (oldNum + num);</span><br><span class="line">    objTask.setAttrInt(<span class="string">'num'</span>, newNum);</span><br><span class="line">    isRemoveListener = isMax;</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> isRemoveListener;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 常规通用任务触发</span></span><br><span class="line"><span class="comment"> * 拥有型</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; objTask 任务Obj</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; num 数量</span></span><br><span class="line"><span class="comment"> * @return &#123;Boolean&#125; 是否移除任务监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commonHaveTrigger</span> (<span class="params">objTask, num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isRemoveListener;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tbObjTask = Config.getTbObjTask(objTask.getAttrInt(<span class="string">'type'</span>), objTask.getAttrInt(<span class="string">'cfgId'</span>));</span><br><span class="line">    <span class="keyword">if</span>(!tbObjTask) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> maxNum = tbObjTask[<span class="string">"num"</span>];</span><br><span class="line">    <span class="keyword">let</span> isMax = num &gt;= maxNum;</span><br><span class="line">    <span class="keyword">let</span> newNum = isMax ? maxNum : num;</span><br><span class="line">    objTask.setAttrInt(<span class="string">'num'</span>, newNum);</span><br><span class="line">    isRemoveListener = isMax;</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> isRemoveListener;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 常规通用任务触发</span></span><br><span class="line"><span class="comment"> * 排名型</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; objTask 任务Obj</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; num 名次</span></span><br><span class="line"><span class="comment"> * @return &#123;Boolean&#125; 是否移除任务监听</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commonRankTrigger</span> (<span class="params">objTask, num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isRemoveListener;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tbObjTask = Config.getTbObjTask(objTask.getAttrInt(<span class="string">'type'</span>), objTask.getAttrInt(<span class="string">'cfgId'</span>));</span><br><span class="line">    <span class="keyword">if</span>(!tbObjTask) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> maxNum = tbObjTask[<span class="string">"num"</span>];</span><br><span class="line">    <span class="keyword">let</span> isMax = num &lt;= maxNum;</span><br><span class="line">    <span class="keyword">let</span> newNum = isMax ? maxNum : num;</span><br><span class="line">    objTask.setAttrInt(<span class="string">'num'</span>, newNum);</span><br><span class="line">    isRemoveListener = isMax;</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> isRemoveListener;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 常规通用任务触发</span></span><br><span class="line"><span class="comment"> * ALL型</span></span><br><span class="line"><span class="comment"> * ！此类型有外部任务种类统计任务剩余数量为0时会出发一次</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commonAll</span>(<span class="params">objTask, type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isRemoveListener;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    isRemoveListener = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span>(objTask.getAttrInt(<span class="string">'type'</span>) !== type) &#123; <span class="comment">//类型相同则完成</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> tbObjTask = Config.getTbObjTask(objTask.getAttrInt(<span class="string">'type'</span>), objTask.getAttrInt(<span class="string">'cfgId'</span>));</span><br><span class="line">    <span class="keyword">if</span>(!tbObjTask) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> maxNum = tbObjTask[<span class="string">"num"</span>];</span><br><span class="line">    objTask.setAttrInt(maxNum);</span><br><span class="line">    isRemoveListener = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> isRemoveListener;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>时间准备的不够充足，先写到这里吧，下篇再具体讲解。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/16/游戏任务系统的设计(上)/" data-id="cjlvo0oq7000b4svn1wwuhq3x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-使用消息字典做消息校验" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/09/使用消息字典做消息校验/" class="article-date">
  <time datetime="2018-07-09T02:06:53.000Z" itemprop="datePublished">2018-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/09/使用消息字典做消息校验/">使用消息字典做消息校验</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>基于Http通信的游戏服务器和客户端一般首选JSON作为数据传输格式，通信参数校验是很琐碎的事。往往一些人为利用的BUG都与没有正确的参数校验，比如扣钱的参数传输负数等。人为做消息请求做参数校验又不能避免漏掉参数校验，我们需要一套行之有效的参数校验框架。本文主要讲如何利用做消息字典做消息检验。<br>下文主要以物品使用item_use消息做案例</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>通常的消息处理如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 物品使用</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; msg 消息体</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; msg.itemID 物品ID</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; msg.itemNum 物品数量</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; session 抽象连接对象</span></span><br><span class="line"><span class="comment"> * @param &#123;Function&#125; next 消息返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">item_use</span>(<span class="params">msg, session, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(msg.itemID === <span class="literal">undefined</span> || !<span class="built_in">Number</span>.isFinite(msg.itemID) || msg.itemID &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> next(&#123;<span class="attr">retCode</span>:<span class="string">'error param'</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(msg.itemNum === <span class="literal">undefined</span> || !<span class="built_in">Number</span>.isFinite(msg.itemNum) || msg.itemNum &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> next(&#123;<span class="attr">retCode</span>:<span class="string">'error param'</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时参数还少，手写基本还OK，一旦参数10或者更多，相信你写这逻辑时，会吐的。</p>
<h2 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">msgCfg.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"comment"</span> : &#123;</span><br><span class="line">    <span class="attr">"消息名"</span> : &#123;</span><br><span class="line">      <span class="attr">"comment"</span> : <span class="string">"备注"</span>,</span><br><span class="line">      <span class="attr">"param"</span> : &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"val"</span> : &#123;</span><br><span class="line">    <span class="attr">"item_use"</span> : &#123;</span><br><span class="line">      <span class="attr">"comment"</span> : <span class="string">"物品使用"</span>,</span><br><span class="line">      <span class="attr">"param"</span> : &#123;</span><br><span class="line">        <span class="attr">"itemID"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"Number"</span>,</span><br><span class="line">          <span class="attr">"comment"</span> : <span class="string">"物品ID"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"itemNum"</span> : &#123;</span><br><span class="line">          <span class="attr">"type"</span> : <span class="string">"Number"</span>,</span><br><span class="line">          <span class="attr">"comment"</span> : <span class="string">"物品数量"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个JSON文件msgCfg.json作为消息字典，并在其中添加物品使用的消息，格式类似如上。写一个消息管理模块MsgMng.js，在消息收到和功能处理前进行参数校验（！不是在item_use内，是item_use调用前），基本逻辑如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MsgMng</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.msgParam = <span class="built_in">require</span>(<span class="string">'msgCfg.json'</span>).val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @description 参数校验</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; route</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; msg</span></span><br><span class="line"><span class="comment"> * @return &#123;null | Number&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MsgMng.prototype.paramCheck = <span class="function"><span class="keyword">function</span> (<span class="params">route, msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> err = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> param = <span class="keyword">this</span>.msgParam[route];</span><br><span class="line">    <span class="keyword">if</span>(!param) &#123;</span><br><span class="line">      logger.info(<span class="string">"msg: "</span> + route + <span class="string">" not register"</span>);</span><br><span class="line">      err = RetCode.HTTP_CODE_401;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> k <span class="keyword">in</span> param) &#123;</span><br><span class="line">      <span class="keyword">let</span> key = <span class="string">''</span> + k;</span><br><span class="line">      <span class="keyword">let</span> type = param[key][<span class="string">"type"</span>];</span><br><span class="line">      <span class="keyword">let</span> value = msg[key];</span><br><span class="line">      <span class="keyword">if</span>(value === <span class="literal">undefined</span> || value === <span class="literal">null</span> || type !== value.constructor.name || (value.constructor === <span class="built_in">Number</span> &amp;&amp; (value &lt; <span class="number">0</span> || !<span class="built_in">Number</span>.isFinite(value)))) &#123;</span><br><span class="line">        logger.info(<span class="string">"msg: "</span> + route + <span class="string">" param is:[%s], reqMsg is:[%s]"</span>, route, <span class="built_in">JSON</span>.stringify(param), <span class="built_in">JSON</span>.stringify(msg));</span><br><span class="line">        err = RetCode.ERROR_REQUEST_PARAM;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> err;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样新增消息只要在消息字典内配置好消息包名参数类型就能处理绝大多数参数校验的代码量了。</p>
<h2 id="继续深挖"><a href="#继续深挖" class="headerlink" title="继续深挖"></a>继续深挖</h2><p>消息字典的用途不止这个简单的作用</p>
<ul>
<li>前后端对应消息作为标准</li>
<li>消息功能和参数查询方便</li>
<li>模块交接减少难度</li>
<li>NX点直接做为消息生成模板</li>
<li>为每个参数配置测试模式值</li>
<li>可以自己改造，具体参数注册校验函数</li>
<li>自己想吧…</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不想盲婚哑嫁，消息字典应该是Http通讯必不可少的一部分。减少体力活，是一个合格的码农应该觉醒的意识。只有效率提升上去，才能搬更多的砖。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/09/使用消息字典做消息校验/" data-id="cjlvo0oq000044svnk6phk1j4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-基于json格式的玩家数据兼容" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/02/基于json格式的玩家数据兼容/" class="article-date">
  <time datetime="2018-07-02T02:14:29.000Z" itemprop="datePublished">2018-07-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/02/基于json格式的玩家数据兼容/">基于json格式的玩家数据兼容</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>游戏开发中，玩家数据格式不是一成不变的，保证玩家数据格式变更后玩家上线后依然能够进行游戏是基本原则。<br>本文主要阐述数据库是Mysql时，以玩家表human为例子说明玩家数据兼容的一些方法。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`human`</span> (</span><br><span class="line">    <span class="string">`uid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'玩家唯一ID'</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'玩家名字'</span>,</span><br><span class="line">    <span class="string">`head`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">DEFAULT</span> <span class="string">'[1,1,3]'</span> <span class="keyword">COMMENT</span> <span class="string">'当前头像'</span>,</span><br><span class="line">    <span class="string">`exp`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'当前经验'</span>,</span><br><span class="line">    <span class="string">`level`</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'当前等级'</span>,</span><br><span class="line">    <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'玩家年龄'</span>,</span><br><span class="line">    <span class="string">`gold`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'当前元宝数'</span>,</span><br><span class="line">    <span class="string">`diamond`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'当前钻石数量'</span>,</span><br><span class="line">    <span class="string">`VIP`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'VIP等级'</span>,</span><br><span class="line">    <span class="string">`ctGetSkin`</span> <span class="built_in">text</span> <span class="keyword">COLLATE</span> utf8_unicode_ci <span class="keyword">COMMENT</span> <span class="string">'已获得不重复皮肤CfgId'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`uid`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COLLATE</span>=utf8_unicode_ci <span class="keyword">COMMENT</span>=<span class="string">'玩家基础信息'</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">human对象结构</span><br><span class="line">&#123;</span><br><span class="line">    uid:<span class="number">0</span>,</span><br><span class="line">    name:<span class="string">''</span>,</span><br><span class="line">    exp:<span class="number">0</span>,</span><br><span class="line">    level:<span class="number">0</span>，</span><br><span class="line">    age:<span class="number">0</span>,</span><br><span class="line">    gold:<span class="number">0</span>,</span><br><span class="line">    diamond:<span class="number">0</span>,</span><br><span class="line">    VIP:<span class="number">0</span>,</span><br><span class="line">    ctGetSkin:<span class="string">'&#123;&#125;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一、增删某个字段"><a href="#一、增删某个字段" class="headerlink" title="一、增删某个字段"></a>一、增删某个字段</h2><p>eg.策划需求变更，需要删除human.age字段<br>1.直接删除tb human.age字段<br>2.删除human实例化对象中age属性</p>
<h2 id="二、字段数据类型变更"><a href="#二、字段数据类型变更" class="headerlink" title="二、字段数据类型变更"></a>二、字段数据类型变更</h2><p>eg.uid从int类型转换为varchar<br>1.tb human.age字段类型能强转，直接转换<br>1.1 human实例化对象中uid属性调整为string</p>
<p>2.human中uid类型不能强转,uid字段可以变更<br>2.1 采用增删字段的解决方式</p>
<p>3.human中uid类型不能强转,uid字段不可以变更<br>3.1 新建字段内uid_1<br>3.2 写策略把uid值调整为目标格式，写到uid_1内<br>3.3 删除uid字段，uid_1字段重命名为uid</p>
<p>3.*的方式不推荐，操作复杂，容易出错。</p>
<h2 id="三、字段内数据内容格式变更"><a href="#三、字段内数据内容格式变更" class="headerlink" title="三、字段内数据内容格式变更"></a>三、字段内数据内容格式变更</h2><p>eg. ctGetSkin:’{id:{num},id:{num}}’ =&gt; ctGetSkin:’{id:{num, liftTime},id:{num, liftTime}}’<br>1.tb human.ctGetSkin 字段不变更<br>1.1 skin对象的添加lifeTime属性<br>1.2 调整ctGetSkin的解析方式,ctGetSkin = OnLoadCtGetSkin(reqly.ctGetSkin);</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CtGetSkin对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CtGetSkinDefault</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Skin对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SkinDefault</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        num:<span class="number">1</span>,</span><br><span class="line">        lifeTime:<span class="number">-1</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对象兼容解析</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ObjCompatible</span>(<span class="params">tarObj, srcObj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!srcObj) &#123;</span><br><span class="line">        <span class="keyword">return</span> tarObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> srcObj === <span class="string">'string'</span>)&#123;</span><br><span class="line">        srcObj = <span class="built_in">JSON</span>.parse(srcObj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> srcObj !== <span class="string">'object'</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> tarObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> tarObj)&#123;</span><br><span class="line">        <span class="keyword">let</span> k = i + <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span>(srcObj[k] === <span class="literal">undefined</span> || srcObj[k] === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> tarObj[k] === <span class="string">'object'</span>) &#123;</span><br><span class="line">            ObjCompatible(tarObj[k], srcObj[k]);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        tarObj[k] = srcObj[k];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tarObj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据解析容错</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OnLoadCtGetSkin</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> ret = CtGetSkinDefault();</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data === <span class="string">'string'</span>) &#123;</span><br><span class="line">        data = <span class="built_in">JSON</span>.parse(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> data !== <span class="string">'object'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//应该做一个属性递归判断</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> k <span class="keyword">in</span> ret) &#123;</span><br><span class="line">        <span class="keyword">if</span>(data[k] === <span class="literal">undefined</span> || data[k] === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ret[k] = ObjCompatible(SkinDefault(), data[k]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="归纳总结"><a href="#归纳总结" class="headerlink" title="归纳总结"></a>归纳总结</h2><p>分析完上面三个场景解决方案，发现OnLoadCtGetSkin的这种方式可以通用。只要设计好一套的human解析方式，兼容问题代码方面基本不会出问题，所有关注点就在table调整上了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/02/基于json格式的玩家数据兼容/" data-id="cjlvo0oq300074svn2aqs338d" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-NodeJS公会服的设计思路" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/25/NodeJS公会服的设计思路/" class="article-date">
  <time datetime="2018-06-25T01:55:34.000Z" itemprop="datePublished">2018-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/25/NodeJS公会服的设计思路/">NodeJS公会服的设计思路</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h1><p>公会是游戏功能中玩家数据交互最为频繁的一个功能，如何让多个玩家操作同一份数据有序而不出错是个很值得非常重要的问题。NodeJS服务器由于无阻塞、单线程、异步、集群的特点使得此功能难点又增加N个百分点，本文分享自己单进程公会服的设计经验。</p>
<h2 id="核心问题"><a href="#核心问题" class="headerlink" title="核心问题"></a>核心问题</h2><ul>
<li>其它服务器和公会服交互</li>
<li>公会服如何承担访问压力</li>
<li>公会玩家基本信息同步问题</li>
<li>同一公会中会长A请求把会员C设为副会长和副会长B把会员C设为大队长，操作如何保证会员C最终职位为副会长，副会长B操作被否决。</li>
<li>公会A和公会B同时批准玩家C入会，如何保障先到先得，玩家C只在一个公会。</li>
</ul>
<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><ul>
<li>传统方式采用RPC方式,比如客户端GameServer访问需要修改公会数据</li>
<li>通过Redis发布订阅，比如一些广播请求</li>
</ul>
<h3 id="服务器压力"><a href="#服务器压力" class="headerlink" title="服务器压力"></a>服务器压力</h3><ul>
<li>公会服除内存存放数据外另外在Redis缓存维护一份供其它进程读取。</li>
<li>客户端不和公会服连接，所有操作都是通过GameServer转发</li>
<li>客户端对公会的查询操作，通过GameServer访问Redis即可</li>
<li>GameServer承担客户端消息的基本容错，只有存在修改数据时才访问公会服</li>
<li>公会成员、公会申请、公会操作日志等数据量较大的UI上做为子标签页打开访问</li>
</ul>
<h3 id="玩家信息同步问题"><a href="#玩家信息同步问题" class="headerlink" title="玩家信息同步问题"></a>玩家信息同步问题</h3><ul>
<li>创建公会成员数据对象，分别有姓名、等级、在线时间、公会ID、职位、入会时间、公会贡献等属性</li>
<li>没有申请、创建、加入公会的没有此对象，</li>
<li>创建公会成员不和公会对象直接绑定,公会只是公会成员的一个属性</li>
<li>玩家上下线同步此对象数据，如有特殊需求，可做策略比如每3小时同步一次数据</li>
</ul>
<h3 id="数据锁问题"><a href="#数据锁问题" class="headerlink" title="数据锁问题"></a>数据锁问题</h3><ul>
<li>每个公会对象和每个公会成员对象增加一个属性，标识是否为不可写状态</li>
<li>每个公会对象和每个公会成员对象增加一个消息队列，用来存放等待的请求</li>
<li>公会对象、公会成员对象为不可写状态时，数据访问需要等待直到状态解除</li>
<li>等待状态保护机制一定时间内不返回，请求当失败返回</li>
<li>修改公会加公会锁，修改玩家加玩家锁，同时修改时，需要同时加，访问也要等待所有状态解除</li>
</ul>
<h2 id="瓶颈"><a href="#瓶颈" class="headerlink" title="瓶颈"></a>瓶颈</h2><p>由于是采用单进程，虽然有策略分担了大部分压力，但终究对于大部分玩家都在操作工作时会出问题。所以，对公会的功能开发需要仔细考虑，比如公会功能放到一定等级才开放，公会部分操作设置冷却时间，部分功能可以考虑利用redis在其它进程实现。而这进一步，则需要的更加缜密的思维，以及天才般的想法。</p>
<h2 id="关于公会集群的想法"><a href="#关于公会集群的想法" class="headerlink" title="关于公会集群的想法"></a>关于公会集群的想法</h2><p>由于公会都有固定的ID，我们可以通过Hash算法使每次对公会的操作准确命中对应的进程。当然，肯定还有其它坑要踩，比如两个公会操作同一个玩家数据时，怎么对应。知识范围有限，还未有有效的方法。</p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>又到了说再见的时候了，此方案果然经不起仔细的推敲，知识掌握程度限制了对自己的思维能力。技术能力又使自己不能干脆的做出用C++或者GO语言实在公会服的设计决定。<br>总之，思路依然幼稚，贻笑大方了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/25/NodeJS公会服的设计思路/" data-id="cjlvo0opx00024svnm9sftk47" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-NodeJS基于Redis广播服的设计思路" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/20/NodeJS基于Redis广播服的设计思路/" class="article-date">
  <time datetime="2018-06-20T05:14:43.000Z" itemprop="datePublished">2018-06-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/20/NodeJS基于Redis广播服的设计思路/">NodeJS基于Redis广播服的设计思路</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h1><p>分布式集群是NodeJS游戏服务端一个基本要素，多进程间玩家通讯是游戏服的一个核心问题。目前常见的多进程广播数据的方式一种是通过RPC，另一种是Redis，本文主要讲通过使用Redis来实现。</p>
<h2 id="广播服设计基本规则"><a href="#广播服设计基本规则" class="headerlink" title="广播服设计基本规则"></a>广播服设计基本规则</h2><ul>
<li>广播服务器，只做登录、心跳、顶号、下线、广播数据基本逻辑功能。登录、心跳、顶号、下线是为了广播数据做辅助功能。</li>
<li>单纯广播服务器一般是为短连接主服务器服务的，长连接的主服务器除了做广播服还要做链接保持服，同样不做其它逻辑。</li>
<li>其它逻辑，比如向好友发信息，应交给逻辑服务器GameServer做。eg:逻辑服收到给好友发信息消息，判断完毕，具体向某个人广播时才向广播服指定人广播。</li>
<li>通过Redis的发布订阅方式，监听指定channel来实现。</li>
</ul>
<h2 id="一个全服广播服的设计思路"><a href="#一个全服广播服的设计思路" class="headerlink" title="一个全服广播服的设计思路"></a>一个全服广播服的设计思路</h2><ul>
<li>Redis发布消息时应明确ServerID_ChanneelName,以缩小广播范围。</li>
<li>发布的消息应包含消息包名，已为了客户端做区分</li>
<li>单独向指定人广播的消息应指定目标人</li>
<li>设计一个ServerRoom的房间类，已Server为单位Redis订阅各自独立的ServerID_ChanneelName</li>
<li>玩家登陆后，查找自身ServerID对应的房间，若没有则需要创建并加入此房间。</li>
<li>每个聊天服需要订阅ChanneelName比如Notice以便做全服通知</li>
</ul>
<p>eg:发布<br>向1001服的UID为1001@234, 1001@100的玩家聊天</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ChanneelName：<span class="string">"1001_Chat"</span></span><br><span class="line">&#123;</span><br><span class="line">    packageName: “fiend.chat”, <span class="comment">//包名</span></span><br><span class="line">    msg:<span class="string">"你好a"</span>, <span class="comment">//广播内容</span></span><br><span class="line">    <span class="string">"to"</span>:[<span class="number">1001</span>@<span class="number">234</span>, <span class="number">1001</span>@<span class="number">100</span>]/<span class="string">'all'</span>, <span class="comment">//接收单个uid或多个UID数组,当为all时表示当前channel所有人</span></span><br><span class="line">&#125;</span><br><span class="line">ChanneelName：<span class="string">"Notice"</span></span><br><span class="line">&#123;</span><br><span class="line">    packageName: “notice.item”, <span class="comment">//包名</span></span><br><span class="line">    msg:<span class="string">"你好a"</span>, <span class="comment">//广播内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>eg:订阅<br>1.各个订阅ChanneelName：”1001_Chat”的聊天服收到订阅消息，根据to字段判断接收人群，再向目标人发送消息<br>2.各个订阅ChanneelName：”Notice”的聊天服,遍历所有ServerRoom向所有人广播</p>
<h1 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h1><p>比较仓促，还不会插入示意图，思路应该说清楚了，再具体还是文采匮乏啊！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/20/NodeJS基于Redis广播服的设计思路/" data-id="cjlvo0opq00004svnmmm8hgkk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/09/10/广播服压测总结/">广播服压测总结</a>
          </li>
        
          <li>
            <a href="/2018/08/13/游戏任务系统的设计(下)/">游戏任务系统的设计(下)</a>
          </li>
        
          <li>
            <a href="/2018/08/06/基于RPC的分布式广播服设计思路/">基于RPC的分布式广播服设计思路</a>
          </li>
        
          <li>
            <a href="/2018/07/31/提问的智慧-读书笔记/">提问的智慧-读书笔记</a>
          </li>
        
          <li>
            <a href="/2018/07/26/玩家定时器模块的设计与实现/">玩家定时器模块的设计与实现</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 wangkm<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>